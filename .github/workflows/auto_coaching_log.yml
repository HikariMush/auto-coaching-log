name: Auto Coaching Log Processor

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  schedule:
    - cron: '*/20 * * * *' # 20åˆ†ã”ã¨ï¼ˆ1æ—¥72å›ï¼‰

# ä¸¦åˆ—å®Ÿè¡Œã‚’é˜²æ­¢ï¼ˆå‰ã®å®Ÿè¡ŒãŒçµ‚ã‚ã‚‹ã¾ã§æ¬¡ã®å®Ÿè¡Œã‚’å¾…ã¤ï¼‰
concurrency:
  group: coaching-log-processing
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6æ™‚é–“ï¼ˆå¿µã®ç‚ºé•·ã‚ã«ï¼‰

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "âœ… System dependencies installed"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # All required packages for coaching_log_processor.py and generalize.py
          pip install \
            google-genai \
            groq \
            patool \
            google-api-python-client \
            google-auth-httplib2 \
            google-auth-oauthlib \
            requests \
            python-dotenv \
            discord.py \
            dspy-ai \
            pinecone
          echo "âœ… Python dependencies installed"

      - name: Validate Environment Variables
        run: |
          python -c "
          import os
          required = ['GEMINI_API_KEY', 'NOTION_TOKEN']
          missing = [v for v in required if not os.environ.get(v)]
          if missing:
              print(f'âŒ Missing env vars: {missing}')
              exit(1)
          print('âœ… Required environment variables are set')
          "
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}

      # --- Step 1: Log Generation (äº‹å®Ÿã®è¨˜éŒ²) ---
      - name: Run Auto Logger (coaching_log_processor.py)
        timeout-minutes: 180
        continue-on-error: true
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          ADMIN_USER_ID: ${{ secrets.ADMIN_USER_ID }}
        run: |
          echo "ğŸš€ Starting coaching_log_processor.py..."
          python coaching_log_processor.py
          echo "âœ… coaching_log_processor.py completed"

      # --- Step 2: Knowledge Generalization (è§£é‡ˆã®è“„ç©) ---
      - name: Run Generalization (generalize.py)
        timeout-minutes: 180
        continue-on-error: true
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ Starting generalize.py..."
          python scripts/generalize.py
          echo "âœ… generalize.py completed"

      - name: Workflow Summary
        if: always()
        run: |
          echo "ğŸ“Š Workflow completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… Auto Coaching Log pipeline executed successfully"
