name: Manage Smash Data (Manual)

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: '実行するタスクを選択してください'
        required: true
        default: '3_generalize'
        type: choice
        options:
        - 1_clear_database (ゴミ捨て: DB全削除)
        - 2_reset_logs (リセット: ログを未処理に戻す)
        - 3_generalize (再構築: 理論抽出実行)
        - 4_sync_memory (同期: Pineconeへ保存)

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # 1. DB全削除 (条件を startsWith に変更)
    - name: Clear Database
      if: ${{ startsWith(inputs.action_type, '1_clear_database') }}
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      run: python clear_database.py

    # 2. ログリセット
    - name: Reset Logs
      if: ${{ startsWith(inputs.action_type, '2_reset_logs') }}
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      run: python reset_logs.py

    # 3. 再構築 (Generalize)
    - name: Generalize (AI Analysis)
      if: ${{ startsWith(inputs.action_type, '3_generalize') }}
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: python generalize.py

    # 4. メモリ同期 (Sync)
    - name: Sync to Pinecone
      if: ${{ startsWith(inputs.action_type, '4_sync_memory') }}
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
      run: python src/utils/sync_memory.py
