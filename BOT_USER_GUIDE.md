# SmashZettel-Bot ユーザーガイド（V3最終版）

## 🤖 現在のBotができること

### 基本コマンド

#### 1. `/ask` - 質問する
```
/ask question:"マリオの空前の確定反撃は？"
```

**Bot内部の動作**:
1. Intent分類（frame_data or theory）
2. クエリ拡張（質問を複数の観点に分解）
3. Pinecone検索（各観点で10件×5 = 最大50件）
4. Re-ranking（LLMで関連性を1-10評価）
5. 上位10件を使用して回答生成

**回答形式**（構造化）:
```
[1] フレームデータ・基礎情報
マリオの空前は発生3F、全体29F、着地硬直9Fです。

[2] 技術的解説
ガード硬直差: 発生3F + 着地9F = -9F
相手側は+9F有利になります。

[3] 実戦での使い方
確定反撃技:
1. 掴み（F6）: 確実に確定
2. 弱攻撃（F2-3）: 確定
3. 上強（F5）: 確定

[4] 補足・注意点
初心者の場合、最も簡単な掴みを推奨します。
```

#### 2. スレッド内での追加質問
```
# /askで質問 → スレッドが自動作成
# スレッド内で普通にメッセージを送る
「他にどんな技が確定する？」
```

**Bot内部の動作**:
1. 過去10件のメッセージを取得
2. **会話要約**（関連情報だけを抽出）
3. 要約された文脈を考慮して回答

#### 3. `/teach` - 全文修正
```
/teach question:"マリオの空前は？" 
       correction:"マリオの空前は発生3F、全体29F、着地硬直9Fです。
                   ガードされると-9Fなので掴み（F6）が確定します。"
```

#### 4. `/teach_element` - 要素別修正（推奨）
```
/teach_element question:"マリオの空前は？" 
               element_number:2 
               correction:"硬直差の計算式を明記すべき: 発生3F + 着地9F = -9F"
```

#### 5. `/status` - Bot状態確認
```
/status
# QAログ数、トレーニングデータ数などを表示
```

---

## 🎓 DSPy深化のための質問例

### レベル1: 基礎データ（フレームデータ確認）

**目的**: [1]フレームデータ・基礎情報の強化

```
質問例:
- マリオの空前の発生フレームは？
- ネスの空後のダメージは？
- クラウドの横Bの全体フレームは？
- ピカチュウの雷の発生は？
- ドンキーの空下の着地硬直は？

期待される回答:
- 数値の正確性
- 単位の明記（F、%）
- 関連データの提示（発生だけでなく全体や硬直も）

フィードバックすべきポイント:
- 数値が間違っている → /teach_element element_number:1
- 単位が欠けている → /teach_element element_number:1
- 関連データが不足 → /teach_element element_number:1
```

### レベル2: 技術計算（硬直差、確定反撃）

**目的**: [2]技術的解説の強化

```
質問例:
- マリオの空前をガードした時の硬直差は？
- ネスの空後をガードした時の確定反撃は？
- クラウドの横Bの確定反撃は何F以内？
- ピカチュウの雷をガードした時、何が確定する？
- シールド削り値の計算方法は？

期待される回答:
- 計算式の明記（発生 + 着地硬直 = 硬直差）
- 確定反撃技のリスト
- キャラ差の考慮

フィードバックすべきポイント:
- 計算式が欠けている → /teach_element element_number:2 correction:"発生X + 着地Y = 硬直差Zと計算式を明記"
- 確定反撃技が不完全 → /teach_element element_number:2 correction:"掴み、弱、上強も確定することを追記"
- キャラ差の説明不足 → /teach_element element_number:2 correction:"一部キャラ（掴みF8）は非確定と補足"
```

### レベル3: 立ち回り・戦術

**目的**: [3]実戦での使い方の強化

```
質問例:
- マリオの空前の使いどころは？
- ネスの空後で復帰阻止する時の注意点は？
- クラウドの横Bはどういう時に使う？
- 復帰阻止の判断基準は？
- 崖上がりの選択肢と読み合いは？

期待される回答:
- 具体的な使用場面（3つ以上）
- リスク・リターンの評価
- 状況別の選択肢

フィードバックすべきポイント:
- 抽象的すぎる → /teach_element element_number:3 correction:"具体例を3つ以上: 1.相手のジャンプ読み 2.着地狩り 3.牽制"
- リスクの説明不足 → /teach_element element_number:3 correction:"外した時の隙、ガードされた時の不利Fも説明"
- 状況の考慮不足 → /teach_element element_number:3 correction:"相手の%、ストック差による使い分けを追記"
```

### レベル4: 初心者サポート・補足

**目的**: [4]補足・注意点の強化

```
質問例:
- 確定反撃って何？
- ガード硬直差の見方は？
- 初心者におすすめのキャラは？
- 復帰阻止が怖い、どうすればいい？
- フレームって何？

期待される回答:
- 用語の説明
- 初心者向けの簡略化
- 段階的な学習パス
- よくある間違いの指摘

フィードバックすべきポイント:
- 専門用語を説明なしで使用 → /teach_element element_number:4 correction:"フレームとは1/60秒の単位と説明を追加"
- 初心者向け配慮不足 → /teach_element element_number:4 correction:"まずは掴みから練習と段階的な推奨を追記"
- 前提知識を仮定しすぎ → /teach_element element_number:4 correction:"ガード硬直差の基本から説明"
```

### レベル5: 複合的・高度な質問

**目的**: 全要素の総合力強化

```
質問例:
- マリオ対クラウドの立ち回りで意識すべきことは？
- 復帰阻止と崖上がり狩りのリスクリターンの違いは？
- コンボの繋ぎ方の基本原則は？
- 相手の%帯によって技選択をどう変えるべき？
- メンタルが崩れた時の対処法は？

期待される回答:
- 複数の要素を統合した回答
- 優先順位の提示
- 状況に応じた柔軟な対応

フィードバックすべきポイント:
- 全体的に良いが1要素だけ弱い → /teach_element で該当要素のみ修正
- 複数要素が不足 → /teach で全文修正
- トーンが熱血的 → /teach correction:"【NG】絶対に！【OK】推奨します"
```

---

## 📝 効果的なフィードバックの書き方

### ✅ 良いフィードバック例

#### 例1: 計算式の明記（要素2）
```
/teach_element question:"マリオの空前をガードした時の硬直差は？" 
               element_number:2 
               correction:"計算式を明記すべき。
                          【計算】
                          発生フレーム: 3F
                          着地硬直: 9F
                          ガード硬直差: 3F + 9F = -9F（ガード側が+9F有利）
                          
                          【確定反撃】
                          相手は9F以内の技で反撃可能:
                          - 掴み（F6-7）: 確定
                          - 弱攻撃（F2-3）: 確定
                          - 上強（F5）: 確定"
```

**なぜ良いか**:
- 計算式が明確
- 具体的な確定技をリスト化
- 要素番号が適切（技術的解説）

#### 例2: 具体的な使用場面（要素3）
```
/teach_element question:"クラウドの空前の使い方は？" 
               element_number:3 
               correction:"抽象的な「差し込みに使える」ではなく、
                          具体的な使用場面を3つ以上列挙すべき:
                          
                          1. 相手のジャンプ読みで置き技として
                             - SJから出して着地隙を減らす
                             - 後隙をDA等でカバー
                          
                          2. 着地狩りの選択肢として
                             - 相手の空中回避を読んで振る
                             - 当たれば低%でコンボ始動
                          
                          3. 崖上がりに対する牽制として
                             - 崖上がり攻撃のタイミングに合わせる
                             - ジャンプ上がりを潰す"
```

**なぜ良いか**:
- 「抽象的すぎる」という問題点を明確化
- 具体例を3つ提示
- 各例に補足説明を追加

#### 例3: トーンの調整（全文修正）
```
/teach question:"初心者におすすめのキャラは？"
       correction:"【NG例】
                   「マリオを使え！絶対に強くなれる！」
                   
                   【OK例】
                   「初心者にはマリオがおすすめです。
                   
                   【理由】
                   1. 技の発生が早く、操作ミスが少ない
                   2. 復帰が安定（上Bのカバー範囲が広い）
                   3. コンボルートがシンプル
                   
                   ただし、リーチが短いため剣士相手は苦戦します。
                   
                   まずはマリオで基礎を学び、慣れたら他キャラも試してください。」
                   
                   【改善ポイント】
                   - 命令形を避け、推奨の形にする
                   - 理由を構造化
                   - デメリットも併記（客観性）"
```

**なぜ良いか**:
- NG/OK例の対比
- 具体的な改善ポイントを明記
- トーン以外の要素（構造化、客観性）も学習できる

---

### ❌ 避けるべきフィードバック例

#### 例1: 曖昧すぎる
```
❌ /teach question:"..." correction:"もっとわかりやすく"
✅ /teach_element element_number:2 correction:"計算式を明記: X + Y = Z"
```

#### 例2: 批判のみ
```
❌ /teach question:"..." correction:"これは間違い"
✅ /teach question:"..." correction:"正しくは: 発生3F、全体29F、着地硬直9Fです"
```

#### 例3: 要素番号のミスマッチ
```
❌ /teach_element element_number:1 correction:"立ち回りで〜"
# → 要素1はフレームデータなので、立ち回りは要素3が適切

✅ /teach_element element_number:3 correction:"立ち回りで〜"
```

---

## 🎯 DSPy深化のための戦略的フィードバック

### フェーズ1: 基礎品質の確立（0-30件）

**目標**: 各要素の基本的な品質を確保

**推奨質問**:
- シンプルなフレームデータ質問（10件）
- 基本的な確定反撃質問（10件）
- 一般的な立ち回り質問（10件）

**フィードバック方法**:
- 明らかに間違っている → `/teach`で全文修正
- 数値が不正確 → `/teach_element element_number:1`
- 計算式がない → `/teach_element element_number:2`
- 具体例が少ない → `/teach_element element_number:3`

**例**:
```
# 質問10件目
/ask question:"マリオの空前のダメージは？"

# Bot回答: "約8%です。"

# フィードバック
/teach_element element_number:1 
               correction:"正確な数値を記載: 初段5.0% + 2段目2.6% = 計7.6%"
```

---

### フェーズ2: 特定要素の強化（30-50件）

**目標**: 弱い要素を集中的に改善

**推奨方法**:
1. 30件のフィードバックを確認
2. 最も修正が多い要素を特定
3. その要素を強化する質問を10-20件追加

**例**: [2]技術的解説が弱い場合

```
# 計算式に焦点を当てた質問を追加
/ask question:"ネスの空後の硬直差の計算方法は？"
/ask question:"クラウドの横Bのガード硬直差は？"
/ask question:"マリオのDAの確定反撃をフレームから計算するには？"

# 各回答に対して
/teach_element element_number:2 correction:"計算過程を段階的に: 1.発生確認 2.硬直確認 3.合計計算"
```

---

### フェーズ3: トーンと一貫性の洗練（50-100件）

**目標**: 人格の調整、表現の統一

**推奨方法**:
- 対比型フィードバック（NG/OK例を提示）
- パターンの明示（「いつも〜という表現を使うが、〜の方が良い」）

**例**:
```
/teach question:"復帰阻止のコツは？"
       correction:"【NG】「崖外で叩け！絶対に強い！」
                   
                   【OK】「崖外で攻撃すると撃墜しやすいですが、
                         自分も復帰できなくなるリスクがあります。
                         
                         【判断基準】
                         1. 自分の復帰力（リスク）
                         2. 相手の復帰ルート（予測可能性）
                         3. ストック差（リスク許容度）
                         
                         初心者の場合、崖上からの復帰阻止から練習することを推奨します。」
                   
                   【改善パターン】
                   - 命令形 → 推奨形
                   - 断定 → 条件付き
                   - リスクを必ず説明"
```

---

### フェーズ4: 高度な思考プロセス（100件以上）

**目標**: 論理展開の洗練

**推奨方法**:
- 模範的な思考プロセスをフィードバック
- 「なぜそう答えるべきか」の理由を明記

**例**:
```
/teach question:"マリオ対クラウドの立ち回りは？"
       correction:"【思考プロセス】
                   
                   1. キャラ性能の比較
                      マリオ: 接近戦が強い、リーチが短い
                      クラウド: リーチが長い、復帰が弱い
                   
                   2. 有利な間合いの特定
                      マリオ有利: 密着〜近距離
                      クラウド有利: 中距離
                   
                   3. 戦略の導出
                      マリオ側: 接近を優先、復帰阻止を狙う
                      クラウド側: 間合い管理、崖上での復帰阻止回避
                   
                   4. 具体的な技選択
                      マリオ: 掴み、下強（接近手段）
                      クラウド: 空前、横強（牽制）
                   
                   5. 推奨行動
                      マリオ側は積極的に接近し、
                      ストック有利時は復帰阻止でリスクを取る価値があります。」
                   
                   【学習させたいパターン】
                   キャラ比較 → 有利間合い → 戦略 → 技選択 → 推奨
                   この論理展開を他のマッチアップでも適用してほしい"
```

---

## 📊 フィードバック効率を最大化するコツ

### 1. 同じ問題が繰り返される場合

**パターン認識**:
```
# 3回連続で計算式が欠けている場合
1回目: /teach_element element_number:2 correction:"計算式を追加: X + Y = Z"
2回目: /teach_element element_number:2 correction:"計算式を追加: A + B = C"
3回目: /teach correction:"【パターン】
                          技術的解説（[2]）には常に計算式を含めるべき。
                          フォーマット:
                          発生Xf + 硬直Yf = 硬直差Zf
                          相手はZ以内の技で反撃可能
                          【例】発生3F + 着地9F = -9F → 掴み（F6）確定"
```

### 2. ポジティブフィードバックも有効

```
# 良い回答に対して
/teach question:"..." correction:"この回答は理想的。
                                  - 計算式が明確
                                  - 具体例が3つ
                                  - リスクも説明
                                  - トーンが穏やか
                                  今後もこのパターンを維持してほしい"
```

### 3. 要素間の連携

```
# 複数要素が連携していない場合
/teach question:"マリオの空前は強い？"
       correction:"【改善】
                   [1]でダメージを示したなら、
                   [3]で「低%時はコンボ始動、高%時は撃墜技として」と
                   ダメージ%を踏まえた使い分けを説明すべき。
                   
                   要素間の連携を意識してほしい。"
```

---

## 🚀 最適化の実行タイミング

### 推奨スケジュール

```
フィードバック数に応じて実行:
- 30件: 初回最適化（基礎確立）
- 50件: 2回目（要素別最適化開始）
- 100件: 3回目（トーン洗練）
- 以降: 2週間に1回、または新しいFB20件ごと
```

### 実行方法

```bash
# 最適化実行
python -m src.utils.optimize_coach

# 履歴確認
ls -lth data/optimization_history/

# 最新のレポート表示
cat data/optimization_history/$(ls -t data/optimization_history/ | head -1)

# Bot再起動
# → 最適化されたモデルが適用される
```

---

## 💡 まとめ

### 現在のBotができること
1. 構造化された回答（[1]〜[4]）
2. スレッド内での会話継続（要約版）
3. 高度な検索（クエリ拡張 + Re-ranking）
4. 要素別フィードバックの受付
5. DSPyによる継続的学習
6. 最適化履歴の自動記録

### DSPy深化のために必要なこと
1. **質問の多様性**: レベル1〜5の質問をバランスよく
2. **フィードバックの具体性**: 「もっと〜」ではなく「〜を追加」
3. **パターンの明示**: 同じ問題が繰り返される場合、パターンとして伝える
4. **ポジティブFBも**: 良い回答のパターンも学習させる

### 次の30件のフィードバックで意識すべきこと
- **[1]フレームデータ**: 数値の正確性、単位の明記
- **[2]技術的解説**: 計算式の明記、確定反撃技のリスト
- **[3]実戦での使い方**: 具体例3つ以上、リスク・リターン
- **[4]補足・注意点**: 初心者向け説明、段階的な学習パス
- **トーン**: 命令形→推奨形、断定→条件付き

Botを使い込むほど賢くなります。フィードバックの質が学習の質を決定します。
