# フィードバック戦略ガイド：DSPy最適化のベストプラクティス

## 概要

このBotは**DSPyによる継続的学習**を実装しています。ユーザーからのフィードバックの質と粒度が、AIコーチの改善速度に直結します。

## 🆕 構造化回答と要素別フィードバック

**V2.0の新機能**: Botの回答は以下の4つの要素で構造化されています：

- **[1] フレームデータ・基礎情報**: 発生F、全体F、ダメージ%などの数値データ
- **[2] 技術的解説**: 硬直差の計算、確定反撃、コンボルートなど
- **[3] 実戦での使い方**: 立ち回りでの使用場面、リスク・リターン
- **[4] 補足・注意点**: キャラ差、初心者向けアドバイスなど

各要素に対して**番号を指定してフィードバック**できます：
```
/teach_element question:"マリオの空前は？" element_number:2 correction:"硬直差の計算式を明記: 発生3F + 着地硬直9F = -9F"
```

これにより、**回答全体は良いが特定の要素だけ改善したい**場合に効率的にフィードバックできます。

---

## フィードバックの種類

### 0. 🔵 要素別修正型（推奨：**V2.0で最も効率的**）

**使用タイミング**: 回答の一部の要素だけ改善したい場合（最も効率的）

**方法**:
```
# 例1: [2]技術的解説が不足している場合
/teach_element question:"マリオの空前の確定反撃は？"
               element_number:2
               correction:"硬直差の計算過程を明記すべき。
                          発生3F + 着地硬直9F = ガードされると-9F。
                          よって相手は9F以内の技で反撃可能。"

# 例2: [3]実戦での使い方が抽象的すぎる場合
/teach_element question:"クラウドの空前の使い方は？"
               element_number:3
               correction:"具体的な使用場面を列挙すべき。
                          1. 相手のジャンプ読みで置き技として
                          2. 着地狩りの選択肢として
                          3. 崖上がりに対する牽制として"

# 例3: [4]補足が欠けている場合
/teach_element question:"ネスの空後は強い？"
               element_number:4
               correction:"初心者向けの補足を追加すべき。
                          『強力ですが、外すと隙が大きいため、
                           確実に当たる場面（復帰阻止、着地狩り）で使いましょう。
                           練習モードで当て感を掴むことが重要です。』"
```

**メリット**:
- **DSPyが最も効率的に学習できる形式**（要素ごとのパターンを抽出）
- ユーザー負担が軽い（修正箇所だけ書けばOK）
- 他の要素は良い場合に無駄な修正をしなくて済む

**デメリット**:
- 要素番号を覚える必要がある（が、4つだけなので簡単）

---

### 1. 🟢 全文修正型（推奨：初期段階、または全体的に改善が必要な場合）

**使用タイミング**: Botの回答が根本的に間違っている、または大幅に改善の余地がある場合

**方法**:
```
/teach question:"マリオの空前の確定反撃は？" 
       correction:"マリオの空前は発生3F、全体29F、着地硬直9F。
                   ガードされた場合、-9Fなので相手の9F以内の技で反撃可能。
                   多くのキャラの掴み（F6-7）や弱攻撃が確定します。"
```

**メリット**:
- ユーザー負担が低い
- 理想的な回答の「トーン」や「構造」もDSPyが学習できる

**デメリット**:
- 何が悪かったのかDSPyが推論する必要がある（学習に時間がかかる）

---

### 2. 🟡 要素分解型（推奨：中期〜長期）

**使用タイミング**: 回答の一部は良いが、特定の要素が欠けている場合

**方法**:
```
/teach question:"マリオの空前の確定反撃は？"
       correction:"【改善点】
                   1. フレームデータの計算過程を示すべき（発生3F + 着地硬直9F = 相手に-9Fの有利）
                   2. 具体的な確定反撃技を列挙すべき（掴み、弱、上強など）
                   3. キャラ差による違いを補足すべき（一部キャラは掴みF8なので非確定）"
```

**メリット**:
- **DSPyが最も効率的に学習できる形式**
- 特定の改善パターン（例: フレーム計算の説明不足）を抽出しやすい

**デメリット**:
- ユーザーの分析力と入力コストが必要

---

### 3. 🔵 対比型（推奨：高度な最適化）

**使用タイミング**: トーンや表現スタイルを調整したい場合

**方法**:
```
/teach question:"クラウドの画竜点睛で復帰阻止するコツは？"
       correction:"【NG例】
                   「絶対に崖外で当てろ！超強いぞ！」
                   
                   【OK例】
                   「画竜点睛は崖外で当てると撃墜しやすいですが、
                    自分も復帰できなくなるリスクがあります。
                    相手の復帰ルートを読み、安全な位置から狙いましょう。」
                   
                   【改善ポイント】
                   - 過度に熱血的な表現を避ける
                   - リスクとリターンを客観的に説明
                   - 条件付きの推奨（「〜の場合は〜」）を使う"
```

**メリット**:
- トーンや人格の最適化に最も効果的
- 良い例と悪い例の対比でDSPyが学習しやすい

**デメリット**:
- 最も入力コストが高い

---

## DSPy最適化のメカニズム

### フィードバックがどう活用されるか

1. **フィードバック収集** (`/teach`コマンド)
   ```
   data/training_data.jsonl に保存
   ```

2. **メトリック評価** ([`optimize_coach.py`](src/utils/optimize_coach.py))
   ```python
   coaching_quality_metric(gold=user_correction, pred=bot_answer)
   ├─ relevance_score (35%)      # 質問への関連性
   ├─ specificity_score (25%)    # キャラ/技の具体性
   ├─ actionability_score (25%)  # 実行可能性
   └─ tone_score (15%)           # トーンの穏やかさ
   ```

3. **DSPy Teleprompter最適化**
   - 30件以上のフィードバックを元に、[`CoachAnswer`](src/brain/core.py:91) Signatureを自動調整
   - プロンプトの表現が段階的に改善される

4. **継続的改善**
   - 最適化を繰り返すたびに、ユーザーの好みに近づく

---

## 推奨フィードバック戦略

### フェーズ1: 初期（0-30件）
**目標**: 基礎的な回答品質の確立

**推奨手法**: 🟢 全文修正型
- 明らかに間違った回答に対して理想的な回答を提示
- トーンの問題（熱血すぎる）も全文で示す

**例**:
```
❌ Bot回答: 「クラウドの空前は絶対に振れ！超強いぞ！」
✅ 修正: 「クラウドの空前は発生9F、リーチと持続が優秀で差し込みに有効です。
         ただしガードされると不利フレームなので、適切な間合い管理が重要です。」
```

### フェーズ2: 中期（30-100件）
**目標**: 特定の弱点の改善

**推奨手法**: 🟡 要素分解型
- 回答の構造的な問題を指摘
- 「フレーム計算の説明が常に欠けている」などのパターンを明示

**例**:
```
/teach question:"ネスの空後の確定反撃は？"
       correction:"【欠けている要素】
                   1. 着地硬直のフレーム数（11F）
                   2. ガード硬直差の計算（発生10F + 着地11F = -11F）
                   3. キャラ別の確定反撃技リスト
                   
                   【追加すべき情報】
                   「ガードされると-11Fなので、大半のキャラの掴み（F6-7）と
                    発生の早い弱攻撃・上強が確定します。」"
```

### フェーズ3: 長期（100件以上）
**目標**: トーンと表現スタイルの洗練

**推奨手法**: 🔵 対比型
- 良い表現と悪い表現を並べて提示
- 細かいニュアンスの違いを学習させる

---

## 特殊なフィードバックケース

### ケース1: 情報は正しいが説明が不親切

**問題**: 「発生3F、全体29F」だけ答えて終わり

**フィードバック方法**:
```
/teach question:"マリオの空前のフレームは？"
       correction:"発生3F、全体29F、着地硬直9Fです。
                   
                   【補足】
                   これは全キャラ中最速クラスの空中攻撃で、
                   コンボ始動や暴れに非常に有効です。
                   
                   【使用場面】
                   - 低%のコンボ始動（空前→上強→空上）
                   - 相手の技の隙に差し込む
                   - ガードされても-9Fなので比較的安全"
```

### ケース2: 前提知識が不足している質問への対応

**問題**: 「確定反撃って何？」という質問に、フレーム計算だけ答える

**フィードバック方法**:
```
/teach question:"確定反撃って何ですか？"
       correction:"確定反撃とは、相手の技をガードした後、
                   こちらの攻撃が確実に当たる状況のことです。
                   
                   【仕組み】
                   1. 相手の技をガード
                   2. 相手が硬直中で動けない
                   3. その硬直中にこちらの技が発生して当たる
                   
                   【例】
                   マリオの空前（着地硬直9F）をガードした場合、
                   ガード側は+9F有利になります。
                   この間に発生9F以内の技（掴みF6など）を出せば確定で当たります。
                   
                   【初心者向け補足】
                   最初は「掴み」を狙うのが簡単です。
                   掴みは大半のキャラでF6-7なので、多くの技に確定します。"
```

### ケース3: トーンの調整

**問題**: 「絶対に〜しろ！」「超強い！」など熱血すぎる表現

**フィードバック方法**:
```
/teach question:"初心者におすすめのキャラは？"
       correction:"【NG】「マリオを使え！絶対に強くなれる！」
                   
                   【OK】「初心者にはマリオがおすすめです。
                         
                         【理由】
                         1. 技の発生が早く、操作ミスが少ない
                         2. 復帰が安定している（上Bのカバー範囲が広い）
                         3. コンボルートがシンプルで覚えやすい
                         
                         ただし、リーチが短いため、
                         リンクやルキナなどの剣士相手は苦戦することもあります。
                         
                         まずはマリオで基礎を学び、
                         慣れたら他キャラも試してみてください。」
                   
                   【改善ポイント】
                   - 断定を避け、推奨の形にする
                   - 理由を構造化して説明
                   - デメリットも併記（客観性）
                   - 段階的な学習パスを提示"
```

---

## 効率的なフィードバックのコツ

### ✅ DO（推奨）

1. **具体例を含める**
   - 「フレームデータを説明すべき」より「発生3F、全体29Fと数値を明記すべき」

2. **改善理由を書く**
   - 「この情報があると初心者がわかりやすい」など

3. **段階的にフィードバック**
   - 同じ問題が繰り返されたら、2回目は要素分解型で詳細に指摘

4. **良い部分も明記**
   - 「フレーム計算は正確だが、使用場面の説明が欠けている」

### ❌ DON'T（非推奨）

1. **曖昧な指摘**
   - 「もっとわかりやすく」→ 何がわかりにくいのか具体的に

2. **単なる批判**
   - 「これは間違い」→ 正しい内容を提示

3. **フィードバックの重複**
   - 同じ問題を何度も全文修正型で送る → 要素分解型に切り替える

---

## 最適化の実行

### フィードバックが30件以上たまったら

```bash
# DSPy最適化を実行
python -m src.utils.optimize_coach
```

**処理内容**:
1. `training_data.jsonl`を読み込み
2. 4次元メトリック（関連性、具体性、実用性、トーン）で評価
3. DSPy Teleprompterがプロンプトを自動調整
4. 最適化されたモデルを保存

**所要時間**: 10-30分  
**コスト**: $5-15（API使用量による）

### 最適化後の確認

```bash
# Botを再起動して新しいモデルを読み込む
# Discord上でいくつか質問して改善を確認
```

---

## まとめ

| フェーズ | フィードバック手法 | 目的 | 件数目安 |
|---------|-----------------|------|---------|
| 初期 | 🟢 全文修正型 | 基礎品質の確立 | 0-30件 |
| 中期 | 🟡 要素分解型 | 特定の弱点改善 | 30-100件 |
| 長期 | 🔵 対比型 | トーン・スタイル洗練 | 100件以上 |

**重要**: DSPyは「demonstration-based learning」なので、質の高いフィードバック10件 > 質の低いフィードバック100件

各フィードバックが**教師データ**として機能するため、丁寧に作成することで最適化効果が飛躍的に向上します。
