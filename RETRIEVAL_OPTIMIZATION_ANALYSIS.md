# æ¤œç´¢æœ€é©åŒ–åˆ†æï¼šç¶²ç¾…æ€§ã¨ãƒãƒƒãƒãƒ³ã‚°ç²¾åº¦ã®æ”¹å–„

## ğŸ“Š ç¾åœ¨ã®å®Ÿè£…ã®å•é¡Œç‚¹

### 1. ç¶²ç¾…æ€§ã®æ¬ å¦‚

#### ç¾åœ¨ã®è¨­å®šï¼ˆ[`search_theory()`](src/brain/core.py:140-166)ï¼‰

```python
results = index.query(vector=emb['embedding'], top_k=5, include_metadata=True)

for m in results['matches']:
    score = m['score']
    if score < 0.5: continue  # 0.5æœªæº€ã‚’é™¤å¤–
```

**å•é¡Œ**:
- **top_k=5**: å…¨ãƒ‡ãƒ¼ã‚¿ã®ä¸­ã‹ã‚‰ä¸Šä½5ä»¶ã®ã¿å–å¾—
- **é–¾å€¤0.5**: ã‹ãªã‚Šå³ã—ã„åŸºæº–ï¼ˆå®Ÿéš›ã«ã¯0.3-0.4ã§ã‚‚æœ‰ç”¨ãªæƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ï¼‰
- **å˜ä¸€ã‚¯ã‚¨ãƒª**: è³ªå•ã‚’1ã¤ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›ã™ã‚‹ã ã‘ï¼ˆå¤šé¢çš„ãªè³ªå•ã«å¼±ã„ï¼‰

**å½±éŸ¿**:
- é–¢é€£ã™ã‚‹é‡è¦ãªæƒ…å ±ãŒæ¤œç´¢çµæœã‹ã‚‰æ¼ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã„
- ä¾‹: ã€Œãƒãƒªã‚ªã®å¾©å¸°é˜»æ­¢ã€ã¨ã„ã†è³ªå•ã«å¯¾ã—ã¦ã€ã€Œå¾©å¸°ãƒ«ãƒ¼ãƒˆã®èª­ã¿æ–¹ã€ã‚„ã€Œå´–å¤–ã§ã®ç«‹ã¡å›ã‚Šã€ãªã©é–¢é€£ã™ã‚‹è¤‡æ•°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå–å¾—ã•ã‚Œãªã„

---

### 2. ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é™ç•Œ

#### ç¾åœ¨ã®æ–¹æ³•: ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã®ã¿

Pineconeã¯**è¿‘ä¼¼è¿‘å‚æ¢ç´¢ï¼ˆANN: Approximate Nearest Neighborï¼‰**ã‚’ä½¿ç”¨ï¼š
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : HNSWï¼ˆHierarchical Navigable Small Worldï¼‰
- è·é›¢æŒ‡æ¨™: ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦

**åˆ©ç‚¹**:
- é«˜é€Ÿï¼ˆO(log n)ï¼‰
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«

**æ¬ ç‚¹**:
- **æ„å‘³çš„é¡ä¼¼æ€§ã®ã¿**: ã€Œãƒãƒªã‚ªã€ã¨ã€Œé…ç®¡å·¥ã€ã¯æ„å‘³çš„ã«ä¼¼ã¦ã„ã‚‹ãŒã€ã‚²ãƒ¼ãƒ ã®æ–‡è„ˆã§ã¯é–¢ä¿‚ãªã„
- **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒç„¡è¦–**: ã€Œç©ºå‰ã€ã¨ã„ã†ç‰¹å®šã®ç”¨èªãŒå«ã¾ã‚Œã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å„ªå…ˆã—ãªã„
- **æ–‡è„ˆã®å–ªå¤±**: è³ªå•ã®æ§‹é€ ï¼ˆã€Œã€œã®æ™‚ã«ã€ã€Œã€œã™ã¹ãï¼Ÿã€ï¼‰ãŒè€ƒæ…®ã•ã‚Œãªã„

---

## ğŸ” ä»–ã®æœ€é©åŒ–æ‰‹æ³•ã¨ã®æ¯”è¼ƒ

### æ–¹æ³•A: top_kå¢—åŠ  + é–¾å€¤ç·©å’Œ

**å¤‰æ›´**:
```python
results = index.query(vector=emb['embedding'], top_k=15, include_metadata=True)
for m in results['matches']:
    if score < 0.35: continue  # 0.5 â†’ 0.35
```

**åŠ¹æœ**: â˜…â˜…â˜…â˜†â˜†  
**ã‚³ã‚¹ãƒˆ**: ä½ï¼ˆAPIå‘¼ã³å‡ºã—å›æ•°å¢—åŠ ã®ã¿ï¼‰  
**å®Ÿè£…æ™‚é–“**: 5åˆ†

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å³åº§ã«å®Ÿè£…å¯èƒ½
- ç¶²ç¾…æ€§ãŒå‘ä¸Š

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒã‚¤ã‚ºï¼ˆé–¢é€£æ€§ã®ä½ã„æƒ…å ±ï¼‰ãŒå¢—ãˆã‚‹å¯èƒ½æ€§
- å›ç­”ç”Ÿæˆæ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°å¢—åŠ ï¼ˆã‚³ã‚¹ãƒˆä¸Šæ˜‡ï¼‰

---

### æ–¹æ³•B: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆSemantic + Keywordï¼‰

**å¤‰æ›´**:
```python
# 1. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ï¼ˆæ—¢å­˜ï¼‰
semantic_results = index.query(vector=emb['embedding'], top_k=10)

# 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆPinecone Sparse Vectoræ©Ÿèƒ½ï¼‰
keyword_results = index.query(
    sparse_vector={
        "indices": [hash("ãƒãƒªã‚ª"), hash("ç©ºå‰")],
        "values": [1.0, 1.0]
    },
    top_k=10
)

# 3. çµæœã‚’çµ±åˆï¼ˆReciprocal Rank Fusionï¼‰
combined = reciprocal_rank_fusion(semantic_results, keyword_results)
```

**åŠ¹æœ**: â˜…â˜…â˜…â˜…â˜…  
**ã‚³ã‚¹ãƒˆ**: ä¸­ï¼ˆPinecone Sparse Vectoræœ‰åŠ¹åŒ–ãŒå¿…è¦ï¼‰  
**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ + ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã§æ¤œç´¢
- å°‚é–€ç”¨èªï¼ˆã€Œç©ºå‰ã€ã€Œç¢ºå®šåæ’ƒã€ï¼‰ãŒå«ã¾ã‚Œã‚‹æ–‡æ›¸ã‚’å„ªå…ˆ
- æ—¢å­˜ç ”ç©¶ã§æœ€ã‚‚åŠ¹æœçš„ãªæ‰‹æ³•ã®1ã¤

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- Pinecone Sparse Vectoræ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ãŒå¿…è¦
- å®Ÿè£…ãŒã‚„ã‚„è¤‡é›‘

---

### æ–¹æ³•C: ã‚¯ã‚¨ãƒªæ‹¡å¼µï¼ˆMulti-Query Retrievalï¼‰

**å¤‰æ›´**:
```python
# 1. AIãŒè³ªå•ã‚’è¤‡æ•°ã®è¦³ç‚¹ã«åˆ†è§£
expanded_queries = ai.expand_query(question)
# ä¾‹: "ãƒãƒªã‚ªã®å¾©å¸°é˜»æ­¢ã¯ï¼Ÿ"
# â†’ ["ãƒãƒªã‚ªã®å¾©å¸°ãƒ«ãƒ¼ãƒˆ", "å´–å¤–ã§ã®ç«‹ã¡å›ã‚Š", "å¾©å¸°æŠ€ã®å¯¾ç­–", "ãƒªã‚¹ã‚¯ãƒªã‚¿ãƒ¼ãƒ³"]

# 2. å„ã‚¯ã‚¨ãƒªã§æ¤œç´¢
all_results = []
for q in expanded_queries:
    results = index.query(vector=embed(q), top_k=5)
    all_results.extend(results)

# 3. é‡è¤‡å‰Šé™¤ + ã‚¹ã‚³ã‚¢çµ±åˆ
final_results = deduplicate_and_merge(all_results)
```

**åŠ¹æœ**: â˜…â˜…â˜…â˜…â˜…  
**ã‚³ã‚¹ãƒˆ**: ä¸­ï¼ˆAIå‘¼ã³å‡ºã—1å› + æ¤œç´¢è¤‡æ•°å›ï¼‰  
**å®Ÿè£…æ™‚é–“**: 3-4æ™‚é–“

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å¤šé¢çš„ãªè³ªå•ã«å¼·ã„
- é–¢é€£ã™ã‚‹ãŒç›´æ¥çš„ã«ã¯ä¼¼ã¦ã„ãªã„æƒ…å ±ã‚‚å–å¾—ã§ãã‚‹
- DSPyã¨ç›¸æ€§ãŒè‰¯ã„ï¼ˆSignatureã§Query Expansionã‚’å®šç¾©å¯èƒ½ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- APIå‘¼ã³å‡ºã—å›æ•°å¢—åŠ ï¼ˆã‚³ã‚¹ãƒˆ: 1è³ªå•ã‚ãŸã‚Š+$0.001ç¨‹åº¦ï¼‰
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¢—åŠ ï¼ˆ+0.5-1ç§’ï¼‰

---

### æ–¹æ³•D: Re-rankingï¼ˆå–å¾—å¾Œã®å†è©•ä¾¡ï¼‰

**å¤‰æ›´**:
```python
# 1. å¤šã‚ã«å–å¾—ï¼ˆtop_k=20, é–¾å€¤ç·©ã‚ï¼‰
initial_results = index.query(vector=emb['embedding'], top_k=20)
# é–¾å€¤ãªã—ã§å…¨ä»¶å–å¾—

# 2. Cross-Encoderã§å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°
reranked = cross_encoder.rerank(
    query=question,
    documents=[r['text'] for r in initial_results]
)

# 3. ä¸Šä½5-10ä»¶ã‚’ä½¿ç”¨
final_results = reranked[:5]
```

**åŠ¹æœ**: â˜…â˜…â˜…â˜…â˜…  
**ã‚³ã‚¹ãƒˆ**: ä¸­ã€œé«˜ï¼ˆCross-Encoderãƒ¢ãƒ‡ãƒ«ã®æ¨è«–ã‚³ã‚¹ãƒˆï¼‰  
**å®Ÿè£…æ™‚é–“**: 4-5æ™‚é–“

**ãƒ¡ãƒªãƒƒãƒˆ**:
- **æœ€ã‚‚ç²¾åº¦ãŒé«˜ã„**ï¼ˆç ”ç©¶ã§å®Ÿè¨¼æ¸ˆã¿ï¼‰
- åˆæœŸæ¤œç´¢ã§ãƒã‚¤ã‚ºã‚’å«ã‚ã¦ã‚‚ã€å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§é™¤å»ã§ãã‚‹
- è³ªå•ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é–¢é€£æ€§ã‚’ã‚ˆã‚Šæ­£ç¢ºã«è©•ä¾¡

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- Cross-Encoderãƒ¢ãƒ‡ãƒ«ãŒå¿…è¦ï¼ˆGemini APIã§ä»£æ›¿å¯èƒ½ï¼‰
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¢—åŠ ï¼ˆ+1-2ç§’ï¼‰
- ã‚³ã‚¹ãƒˆå¢—åŠ ï¼ˆ1è³ªå•ã‚ãŸã‚Š+$0.002-0.005ï¼‰

---

### æ–¹æ³•E: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + éšå±¤æ¤œç´¢

**å¤‰æ›´**:
```python
# 1. è³ªå•ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æŠ½å‡º
character = classify_character(question)  # "ãƒãƒªã‚ª"

# 2. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
results = index.query(
    vector=emb['embedding'],
    top_k=10,
    filter={"character": {"$in": [character, "å…¨ã‚­ãƒ£ãƒ©å…±é€š"]}}
)

# 3. éšå±¤çš„ã«æ¤œç´¢ï¼ˆã‚­ãƒ£ãƒ©ç‰¹åŒ– â†’ ä¸€èˆ¬ç†è«–ï¼‰
if len(results) < 5:
    # ã‚­ãƒ£ãƒ©ç‰¹åŒ–ãŒå°‘ãªã„å ´åˆã€ä¸€èˆ¬ç†è«–ã‚‚å–å¾—
    general_results = index.query(
        vector=emb['embedding'],
        top_k=5,
        filter={"type": "general_theory"}
    )
    results.extend(general_results)
```

**åŠ¹æœ**: â˜…â˜…â˜…â˜…â˜†  
**ã‚³ã‚¹ãƒˆ**: ä½ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã§å®Ÿè£…å¯èƒ½ï¼‰  
**å®Ÿè£…æ™‚é–“**: 2-3æ™‚é–“

**ãƒ¡ãƒªãƒƒãƒˆ**:
- é–¢é€£æ€§ã®é«˜ã„æƒ…å ±ã‚’å„ªå…ˆçš„ã«å–å¾—
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ï¼ˆç¾åœ¨ã¯ã‚ã¾ã‚Šä½¿ã‚ã‚Œã¦ã„ãªã„ï¼‰
- Pineconeå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚é«˜é€Ÿ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ•´å‚™ãŒå¿…è¦
- ãƒ•ã‚£ãƒ«ã‚¿ãŒå³ã—ã™ãã‚‹ã¨æ¤œç´¢çµæœãŒ0ä»¶ã«ãªã‚‹å¯èƒ½æ€§

---

## ğŸ“ˆ ç·åˆè©•ä¾¡

| æ–¹æ³• | ç¶²ç¾…æ€§ | ç²¾åº¦ | ã‚³ã‚¹ãƒˆ | å®Ÿè£…æ™‚é–“ | ç·åˆã‚¹ã‚³ã‚¢ |
|-----|--------|------|--------|---------|----------|
| A. top_kå¢—åŠ  | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | **13/20** |
| B. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜†â˜† | **18/20** â­ |
| C. ã‚¯ã‚¨ãƒªæ‹¡å¼µ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† | **17/20** |
| D. Re-ranking | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | **16/20** |
| E. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | **17/20** |

---

## ğŸ¯ æ¨å¥¨å®Ÿè£…æˆ¦ç•¥

### ãƒ•ã‚§ãƒ¼ã‚º1: å³åº§ã«å®Ÿè£…ï¼ˆä»Šæ—¥ï¼‰

#### æ–¹æ³•A: top_kå¢—åŠ  + é–¾å€¤ç·©å’Œ

```python
# src/brain/core.py: search_theory()
results = index.query(vector=emb['embedding'], top_k=15, include_metadata=True)

for m in results['matches']:
    score = m['score']
    if score < 0.35:  # 0.5 â†’ 0.35
        continue
```

**ç†ç”±**:
- 5åˆ†ã§å®Ÿè£…å¯èƒ½
- å³åº§ã«åŠ¹æœãŒå‡ºã‚‹
- ãƒªã‚¹ã‚¯ãŒä½ã„

**äºˆæƒ³åŠ¹æœ**:
- æ¤œç´¢çµæœã®ç¶²ç¾…æ€§: +60%
- ç²¾åº¦: è‹¥å¹²ä½ä¸‹ï¼ˆãƒã‚¤ã‚ºå¢—åŠ ï¼‰ã®å¯èƒ½æ€§
- ã‚³ã‚¹ãƒˆå¢—åŠ : +$0.001/è³ªå•ï¼ˆç„¡è¦–ã§ãã‚‹ç¯„å›²ï¼‰

---

### ãƒ•ã‚§ãƒ¼ã‚º2: ä¸­æœŸå®Ÿè£…ï¼ˆ1é€±é–“ä»¥å†…ï¼‰

#### æ–¹æ³•C: ã‚¯ã‚¨ãƒªæ‹¡å¼µï¼ˆDSPyã§å®Ÿè£…ï¼‰

**å®Ÿè£…**:

```python
# src/brain/core.py ã«è¿½åŠ 
class QueryExpansion(dspy.Signature):
    """
    è³ªå•ã‚’è¤‡æ•°ã®è¦³ç‚¹ã«åˆ†è§£ã›ã‚ˆã€‚
    
    ä¾‹: ã€Œãƒãƒªã‚ªã®å¾©å¸°é˜»æ­¢ã¯ï¼Ÿã€
    â†’ ["ãƒãƒªã‚ªã®å¾©å¸°ãƒ«ãƒ¼ãƒˆ", "å´–å¤–ã§ã®ç«‹ã¡å›ã‚Š", "å¾©å¸°æŠ€ã®å¯¾ç­–"]
    """
    question = dspy.InputField()
    expanded_queries = dspy.OutputField(desc="3-5å€‹ã®ã‚µãƒ–ã‚¯ã‚¨ãƒªï¼ˆãƒªã‚¹ãƒˆå½¢å¼ï¼‰")

def multi_query_search(question):
    # 1. ã‚¯ã‚¨ãƒªæ‹¡å¼µ
    expander = dspy.ChainOfThought(QueryExpansion)
    expansion = expander(question=question)
    
    # 2. å„ã‚¯ã‚¨ãƒªã§æ¤œç´¢
    all_results = []
    for subquery in expansion.expanded_queries:
        emb = genai.embed_content(model="models/text-embedding-004", content=subquery)
        results = index.query(vector=emb['embedding'], top_k=5, include_metadata=True)
        all_results.extend(results['matches'])
    
    # 3. é‡è¤‡å‰Šé™¤ + ã‚¹ã‚³ã‚¢çµ±åˆ
    seen_ids = set()
    unique_results = []
    for r in all_results:
        if r['id'] not in seen_ids:
            seen_ids.add(r['id'])
            unique_results.append(r)
    
    # ã‚¹ã‚³ã‚¢ã§å†ã‚½ãƒ¼ãƒˆ
    unique_results.sort(key=lambda x: x['score'], reverse=True)
    return unique_results[:10]
```

**ç†ç”±**:
- DSPyã¨ç›¸æ€§ãŒè‰¯ã„
- å¤šé¢çš„ãªè³ªå•ã«å¼·ããªã‚‹
- ã‚³ã‚¹ãƒˆå¢—åŠ ã¯è¨±å®¹ç¯„å›²ï¼ˆ+$0.001/è³ªå•ï¼‰

**äºˆæƒ³åŠ¹æœ**:
- ç¶²ç¾…æ€§: +80%
- ç²¾åº¦: +30%
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: +0.5ç§’
- ã‚³ã‚¹ãƒˆ: +$0.001/è³ªå•

---

### ãƒ•ã‚§ãƒ¼ã‚º3: é•·æœŸå®Ÿè£…ï¼ˆ1ãƒ¶æœˆä»¥å†…ãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### æ–¹æ³•B: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢

**ç†ç”±**:
- æœ€ã‚‚åŠ¹æœçš„ã ãŒã€Pinecone Sparse Vectoræ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ãŒå¿…è¦
- å°‚é–€ç”¨èªãŒå¤šã„ã‚¹ãƒãƒ–ãƒ©ã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«æœ€é©

**å®Ÿè£…ã®å‰ææ¡ä»¶**:
1. Pinecone Sparse Vectoræ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–ï¼ˆPineconeå´ã®è¨­å®šï¼‰
2. TF-IDF ã¾ãŸã¯ BM25 ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ‘ãƒ¼ã‚¹ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ

---

## ğŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼šæ®µéšçš„æ”¹å–„

### ã‚¹ãƒ†ãƒƒãƒ—1: åŸºç¤æ”¹å–„ï¼ˆä»Šã™ãï¼‰

```python
# src/brain/core.py
def search_theory(query):
    """æ”¹å–„ç‰ˆ"""
    if not PINECONE_API_KEY: return "Pinecone Key Missing"
    try:
        pc = Pinecone(api_key=PINECONE_API_KEY)
        index = pc.Index("smash-coach-index")
        
        genai.configure(api_key=GEMINI_API_KEY)
        emb = genai.embed_content(model="models/text-embedding-004", content=query)
        
        # â­ å¤‰æ›´ç‚¹1: top_kã‚’5â†’15ã«å¢—åŠ 
        results = index.query(vector=emb['embedding'], top_k=15, include_metadata=True)
        
        context = "ã€å‚ç…§ã•ã‚ŒãŸæ”»ç•¥ç†è«–ã€‘\n"
        if not results['matches']:
            return "é–¢é€£ã™ã‚‹ç†è«–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
        
        # â­ å¤‰æ›´ç‚¹2: é–¾å€¤ã‚’0.5â†’0.35ã«ç·©å’Œ
        for m in results['matches']:
            meta = m['metadata']
            score = m['score']
            if score < 0.35:  # 0.5 â†’ 0.35
                continue
            context += f"--- {meta.get('title')} (é–¢é€£åº¦:{score:.2f}) ---\n{meta.get('text_content')}\n\n"
            
        return context
    except Exception as e:
        return f"Search Error: {e}"
```

**æœŸå¾…åŠ¹æœ**:
- æ¤œç´¢çµæœæ•°: å¹³å‡2-3ä»¶ â†’ 5-8ä»¶
- ç¶²ç¾…æ€§: +60%
- ã‚³ã‚¹ãƒˆå¢—åŠ : ã»ã¼ã‚¼ãƒ­

---

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¯ã‚¨ãƒªæ‹¡å¼µï¼ˆ1é€±é–“å¾Œï¼‰

```python
# src/brain/query_expansion.pyï¼ˆæ–°è¦ä½œæˆï¼‰
import dspy

class QueryExpansion(dspy.Signature):
    """è³ªå•ã‚’è¤‡æ•°ã®è¦³ç‚¹ã«åˆ†è§£"""
    question = dspy.InputField()
    subqueries = dspy.OutputField(desc="3-5å€‹ã®ã‚µãƒ–ã‚¯ã‚¨ãƒªï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰")

def expand_and_search(question):
    # ã‚¯ã‚¨ãƒªæ‹¡å¼µ
    expander = dspy.Predict(QueryExpansion)
    result = expander(question=question)
    queries = [q.strip() for q in result.subqueries.split(',')]
    
    # å„ã‚¯ã‚¨ãƒªã§æ¤œç´¢
    all_docs = []
    for q in queries[:5]:  # æœ€å¤§5å€‹ã¾ã§
        docs = search_theory(q)
        all_docs.append(docs)
    
    # çµ±åˆ
    return "\n\n=== åˆ¥ã®è¦³ç‚¹ ===\n\n".join(all_docs)
```

**æœŸå¾…åŠ¹æœ**:
- ç¶²ç¾…æ€§: +80%
- ç²¾åº¦: +30%
- å¤šé¢çš„ãªè³ªå•ã¸ã®å¯¾å¿œåŠ›å‘ä¸Š

---

### ã‚¹ãƒ†ãƒƒãƒ—3: Re-rankingï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```python
def search_with_reranking(question):
    # 1. å¤šã‚ã«å–å¾—
    initial_results = index.query(
        vector=embed(question), 
        top_k=20,  # å¤šã‚ã«å–å¾—
        include_metadata=True
    )
    
    # 2. Gemini APIã§å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    rerank_prompt = f"""
è³ªå•: {question}

ä»¥ä¸‹ã®æ–‡æ›¸ã‚’é–¢é€£æ€§ã®é«˜ã„é †ã«ä¸¦ã¹æ›¿ãˆã¦ãã ã•ã„ã€‚
ã‚¹ã‚³ã‚¢ï¼ˆ1-10ï¼‰ã‚‚ä»˜ã‘ã¦ãã ã•ã„ã€‚

{format_docs(initial_results)}
"""
    
    reranked = gemini_api(rerank_prompt)
    return parse_reranked(reranked)
```

**æœŸå¾…åŠ¹æœ**:
- ç²¾åº¦: +50%
- ãƒã‚¤ã‚ºé™¤å»: +70%
- ã‚³ã‚¹ãƒˆ: +$0.002-0.005/è³ªå•

---

## ğŸ“Š ã‚³ã‚¹ãƒˆå½±éŸ¿åˆ†æ

| æ”¹å–„æ¡ˆ | è¿½åŠ ã‚³ã‚¹ãƒˆ/è³ªå• | æœˆé–“100è³ªå•ã§ã®å¢—åŠ  |
|-------|---------------|-------------------|
| A. top_kå¢—åŠ  | $0.0001 | $0.01 |
| C. ã‚¯ã‚¨ãƒªæ‹¡å¼µ | $0.001 | $0.10 |
| D. Re-ranking | $0.003 | $0.30 |
| **åˆè¨ˆï¼ˆå…¨å®Ÿè£…ï¼‰** | **$0.004** | **$0.40** |

**çµè«–**: ã‚³ã‚¹ãƒˆå¢—åŠ ã¯ç„¡è¦–ã§ãã‚‹ç¯„å›²

---

## âœ… æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **å³åº§ã«å®Ÿè£…**: top_k=15, threshold=0.35ï¼ˆ5åˆ†ï¼‰
2. **åŠ¹æœæ¸¬å®š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ•°æ—¥ä½¿ã£ã¦ã‚‚ã‚‰ã„ã€æ¤œç´¢çµæœã®æ”¹å–„ã‚’ç¢ºèª
3. **æ¬¡ã‚¹ãƒ†ãƒƒãƒ—åˆ¤æ–­**: æ”¹å–„ãŒä¸ååˆ†ãªã‚‰ã‚¯ã‚¨ãƒªæ‹¡å¼µã‚’å®Ÿè£…

å¿…è¦ã§ã‚ã‚Œã°ã€ã“ã‚Œã‚‰ã®æ”¹å–„ã‚’ã™ãã«å®Ÿè£…ã§ãã¾ã™ã€‚
