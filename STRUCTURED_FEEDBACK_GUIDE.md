# 構造化フィードバックガイド：回答修正 vs 一般知識

## 🎯 2種類のフィードバック

### タイプ1: 回答への修正（`/teach` or `/teach_element`）
**用途**: この回答を改善する

### タイプ2: 一般知識の追加（`/add_knowledge`）
**用途**: 全ての関連質問に適用される基礎知識

---

## 📝 あなたのフィードバックを分類

### あなたが書いた内容の分類

#### ✅ 回答への修正（4件）

1. **[1]ガーキャン上スマの発生修正**
   - 誤: 12F → 正: 9F
   - **タイプ**: 回答の誤りを修正
   - **コマンド**: `/teach_element`

2. **[2]ベクトル変更とずらしの混同**
   - 概念の混同を指摘
   - **タイプ**: 回答の誤りを修正
   - **コマンド**: `/teach_element`

3. **[3]ポンプの暴れ誤り**
   - ポンプは暴れに使わない
   - **タイプ**: 回答の誤りを修正
   - **コマンド**: `/teach_element`

4. **[4]復帰阻止と崖狩りの混同**
   - 2つの展開を区別すべき
   - **タイプ**: 回答の誤りを修正
   - **コマンド**: `/teach_element`

#### ✅ 一般知識（3件）

1. **ガーキャンの例外ルール**
   ```
   上Bと上スマはガーキャン時にジャンプ踏切の3Fが不要。
   通常のガーキャンジャンプ攻撃: ジャンプF + 攻撃F
   上スマの例外: 攻撃Fのみ
   ```
   - **タイプ**: 一般的な重要知識（全ての関連質問に適用）
   - **コマンド**: `/add_knowledge`

2. **ベクトル変更とずらしの区別**
   ```
   ベクトル変更: 吹っ飛び中に方向を変える
   ずらし: 立ち吹っ飛び時のみ有効
   多段技への対処: ヒットストップ中に半月ずらし → 吹っ飛ぶ瞬間にベクトル変更
   ```
   - **タイプ**: 一般的な重要知識
   - **コマンド**: `/add_knowledge`

3. **復帰阻止と崖上がり狩りの区別**
   ```
   復帰阻止: 崖外から上Bで復帰中を狙う
   崖上がり狩り: 既に崖を掴んでいる状態を狙う
   復帰技の性質（無敵F）を考慮した技選択が重要
   ```
   - **タイプ**: 一般的な重要知識
   - **コマンド**: `/add_knowledge`

---

## 🚀 推奨フィードバック方法

### ステップ1: 回答への修正（4件）

```
# FB1: [1]ガーキャン上スマの発生修正
/teach_element question:"マリオ対策教えて" 
               element_number:1 
               correction:"ガーキャン上スマは9Fで出せます（12Fは誤り）。この回答では12Fと記載されていますが、上スマはガーキャンの例外で、ジャンプ踏切の3Fが不要です。"

# FB2: [2]ベクトル変更とずらしの混同
/teach_element question:"マリオ対策教えて" 
               element_number:2 
               correction:"ベクトル変更とずらしを混同しています。この回答では「スティックを反対方向の斜め上に倒す」とありますが、これはベクトル変更とずらしを混同した説明です。正しくは、吹っ飛び中はベクトル変更、立ち吹っ飛び時はずらしです。"

# FB3: [3]ポンプの暴れ誤り
/teach_element question:"マリオ対策教えて" 
               element_number:3 
               correction:"「下B（ポンプ）による暴れ」は誤りです。ポンプは真下に攻撃判定を持たないため、暴れ着地には使われません。また、マリオの着地狩り対策は、ジャンプで追わず地上ダッシュで軸合わせしてから迎撃が正解です。"

# FB4: [4]復帰阻止と崖狩りの混同
/teach_element question:"マリオ対策教えて" 
               element_number:4 
               correction:"復帰阻止と崖上がり狩りが混同されています。この回答では両者が区別されていませんが、復帰阻止は崖外から上Bで復帰中を狙う、崖狩りは既に崖を掴んでいる状態を狙う、という別の展開です。"
```

### ステップ2: 一般知識の登録（3件）

```
# 一般知識1: ガーキャンの例外ルール
/add_knowledge title:"ガーキャン上スマ・上Bの例外ルール（全キャラ共通）" 
               content:"上Bと上スマはガーキャン時にジャンプ踏切の3Fが不要です。
                        
                        【通常のガーキャンジャンプ攻撃】
                        発生フレーム = ジャンプ踏切F + 攻撃発生F
                        例: ジャンプ3F、空前5F → ガーキャン空前は8F
                        
                        【例外: 上スマと上B】
                        発生フレーム = 攻撃発生Fのみ（ジャンプ不要）
                        例: マリオの上スマ9F → ガーキャン上スマも9F
                        
                        この区別は対策上、最重要事項です。" 
               category:"frame_theory"

# 一般知識2: ベクトル変更とずらしの区別
/add_knowledge title:"ベクトル変更とずらしの区別"
               content:"ベクトル変更とずらしは別の防御技術です。
                        
                        【ベクトル変更】
                        - 適用: 吹っ飛び中（ふっとび硬直中）
                        - 効果: 吹っ飛び方向を変える
                        - 目的: コンボ回避、撃墜回避
                        - 入力: 吹っ飛ぶ瞬間にスティックを倒す
                        
                        【ずらし】
                        - 適用: 立ち吹っ飛び時（弱い吹っ飛び）のみ
                        - 効果: 位置をわずかにずらす
                        - 目的: コンボ回避
                        - 入力: 立ち吹っ飛び中にスティックを倒し続ける
                        
                        【多段技への対処】
                        1. ヒットストップ中: 半月ずらし（スティックを円を描く）
                        2. 吹っ飛ぶ瞬間: ベクトル変更
                        
                        この2つを組み合わせることで、多段技からの脱出率が上がります。"
               category:"mechanic"

# 一般知識3: 復帰阻止と崖上がり狩りの区別
/add_knowledge title:"復帰阻止と崖上がり狩りの区別"
               content:"復帰阻止と崖上がり狩りは別の展開です。
                        
                        【復帰阻止】
                        - 状況: 相手が崖外にいて、復帰技で崖を目指している
                        - 狙い: 復帰技の発生前、または無敵が切れた後を攻撃
                        - 技選択の考慮点:
                          1. 復帰技の無敵F（例: マリオの上B = F3-6無敵）
                          2. 復帰技の攻撃判定位置（例: 上B = 上方向に強い）
                          3. 自分の復帰力（リスク評価）
                        - 推奨技: 下方向に判定が強い技（空下など）
                        
                        【崖上がり狩り】
                        - 状況: 相手が既に崖を掴んでいる
                        - 相手の選択肢: その場上がり、ジャンプ上がり、回避上がり、攻撃上がり、崖離し
                        - 狙い: 読み合いで崖上がり行動を狩る
                        - 技選択: 崖上を広範囲にカバーできる技
                        
                        この2つは完全に別の展開であり、対策技も異なります。"
               category:"strategy"
```

---

## 📊 効果の違い

| 項目 | 回答への修正（/teach_element） | 一般知識（/add_knowledge） |
|------|----------------------------|--------------------------|
| 用途 | この回答の誤りを修正 | 全質問に適用される基礎知識 |
| 適用範囲 | 1つの回答 | 全ての関連質問 |
| DSPy学習 | 最適化時に学習 | 即座にPinecone登録→次の質問から反映 |
| 優先度 | 通常 | 高（メタデータで管理） |
| 上書き | 最適化まで待つ | 即座に反映 |

---

## 🧠 DSPy処理の流れ

### 回答への修正の場合

```
/teach_element → element_feedback.jsonl に保存
↓
30件たまったら
↓
python -m src.utils.optimize_coach
↓
DSPy Teleprompterが学習
↓
最適化されたモデルを生成
↓
Bot再起動で反映
```

**特徴**: 段階的に改善、パターンを学習

---

### 一般知識の場合

```
/add_knowledge → general_knowledge.jsonl に保存
↓
自動的にPinecone に高優先度で登録
↓
次の質問から即座に参照される
```

**特徴**: 即座に反映、検索時に高優先度

---

## 💡 使い分けガイド

### `/teach_element`を使うべきケース

- ✅ この回答の誤りを指摘
- ✅ この回答に不足している情報を追加
- ✅ この回答のトーンを修正

**判断基準**: 「この回答では〜」という表現が使える内容

**例**:
```
「この回答ではガーキャン上スマが12Fと記載されていますが、正しくは9Fです」
→ /teach_element
```

---

### `/add_knowledge`を使うべきケース

- ✅ 全てのガーキャン質問に適用される例外ルール
- ✅ ベクトル変更とずらしの定義（全てのコンボ質問に関連）
- ✅ 復帰阻止の一般的な考え方

**判断基準**: 「〜とは何か」「〜の仕組み」という一般的な説明

**例**:
```
「ガーキャン上スマは全キャラ共通で例外ルールがあり、3Fが不要」
→ /add_knowledge
```

---

## 🔄 あなたのフィードバックの最適な送信方法

### 推奨：7つのコマンドに分割

#### グループA: 回答への修正（4件）

```
/teach_element question:"マリオ対策教えて" element_number:1 correction:"ガーキャン上スマは9Fです（この回答では12Fと記載されていますが誤り）"

/teach_element question:"マリオ対策教えて" element_number:2 correction:"この回答ではベクトル変更とずらしを混同しています。立ち吹っ飛び時はずらし、通常吹っ飛び時はベクトル変更です"

/teach_element question:"マリオ対策教えて" element_number:3 correction:"この回答では「ポンプによる暴れ」と記載されていますが、ポンプは真下に判定がなく暴れには使われません"

/teach_element question:"マリオ対策教えて" element_number:4 correction:"この回答では復帰阻止と崖上がり狩りが混同されています。別の展開として明確に区別すべきです"
```

#### グループB: 一般知識（3件）

```
/add_knowledge title:"ガーキャン上スマ・上Bの例外ルール" 
               content:"上Bと上スマは全キャラ共通でガーキャン時にジャンプ踏切3Fが不要。通常のガーキャン: ジャンプF+攻撃F、例外: 攻撃Fのみ。マリオの上スマ9F→ガーキャン上スマも9F。" 
               category:"frame_theory"

/add_knowledge title:"ベクトル変更とずらしの正確な定義" 
               content:"ベクトル変更=吹っ飛び中に方向変更、ずらし=立ち吹っ飛び時のみ。多段技: ヒットストップ中に半月ずらし→吹っ飛ぶ瞬間にベクトル変更。" 
               category:"mechanic"

/add_knowledge title:"復帰阻止と崖上がり狩りの違い" 
               content:"復帰阻止=崖外から復帰技で崖を目指している状態を狙う。崖狩り=既に崖を掴んでいる状態を狙う。復帰技の無敵Fを考慮して技選択（例: 上B無敵F3-6→下判定の強い技で軌道上を攻める）。" 
               category:"strategy"
```

---

## 📈 効果の違い

### 回答への修正（/teach_element）の効果

- **即座**: なし（最適化まで待つ）
- **30件後**: DSPyが学習 → 同様の誤りをしなくなる
- **適用範囲**: 最適化後の全ての回答
- **学習内容**: 「マリオ対策の質問では〜を注意すべき」

### 一般知識（/add_knowledge）の効果

- **即座**: Pinecone登録 → 次の質問から参照される
- **検索時**: 高優先度で検索結果に含まれる
- **適用範囲**: 全てのガーキャン質問、全てのベクトル変更質問など
- **学習内容**: DSPyも最適化時に参照する

---

## 💡 両方を使うべき理由

### なぜ分割するのか？

**回答修正のみの場合**:
- 最適化まで誤りが修正されない
- 一般知識が蓄積されない

**一般知識のみの場合**:
- この回答の具体的な誤りが記録されない
- DSPyが「どこが間違いやすいか」を学習できない

**両方を使う場合**:
- 即座の改善（一般知識→Pinecone）
- 長期的な改善（回答修正→DSPy最適化）
- 最も効率的

---

## 📝 構造化フィードバックのフォーマット

### フォーマットA: 回答への修正

```
/teach_element question:"[質問]" 
               element_number:[1-4] 
               correction:"【この回答の問題】
                          [何が間違っているか、または何が不足しているか]
                          
                          【修正内容】
                          [どう修正すべきか]
                          
                          【理由】
                          [なぜこの修正が必要か]"
```

### フォーマットB: 一般知識

```
/add_knowledge title:"[知識のタイトル]" 
               content:"【定義】
                       [この知識は何か]
                       
                       【詳細】
                       [計算式、例外ルール、具体例]
                       
                       【重要性】
                       [なぜ重要か、どこに適用されるか]" 
               category:"frame_theory/mechanic/strategy/character_specific"
```

---

## 🎯 カテゴリの使い分け

| カテゴリ | 用途 | 例 |
|---------|------|-----|
| `frame_theory` | フレームに関する理論 | ガーキャンの例外、硬直差の計算 |
| `mechanic` | ゲームシステム | ベクトル変更、ずらし、受け身 |
| `strategy` | 立ち回り・戦術 | 復帰阻止の考え方、間合い管理 |
| `character_specific` | キャラ特化知識 | マリオの上Bの特性 |

---

## ✅ まとめ

### あなたのフィードバックの最適な送信方法

1. **回答修正**: 4つの`/teach_element`（この回答の誤りを指摘）
2. **一般知識**: 3つの`/add_knowledge`（全質問に適用される基礎知識）

**合計7つのコマンド**に分割することで、DSPy学習効率が最大化されます。

### 効果

- 回答修正: 最適化時にパターンとして学習
- 一般知識: 即座にPinecone登録→次の質問から反映

**あなたの専門知識が、最も効率的な形でBotに注入されます。**
