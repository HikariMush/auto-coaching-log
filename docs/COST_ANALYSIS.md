# SmashZettel-Bot: 最適化パイプラインのコスト分析

## 📊 概要

**最適化サイクルにおける 3 つの主要コスト要因**を詳細に分析し、各機能のコストを見積もります。

### 現在の構成

```
SmashTheoryDB (Notion)  →  Pinecone (Vector DB)  →  dspy.Teleprompter (最適化)
         ↓                         ↓                         ↓
    Notion API              Gemini 埋め込み           LLM (Pro/Flash)
    (無料)                   (有料)                   (有料)
```

---

## 💰 API コスト詳細

### 1️⃣ Google Gemini - 埋め込み (Embedding)

**用途**: Notion Theory ページ & raw_data を 768 次元ベクトルに変換

#### 価格体系

```
Model: embedding-001
無料: 6 万 tokens/月
超過: $0.075 / 1M tokens
```

#### コスト計算

**1 ページあたりの Token 数**:
```
Notion Theory ページ平均: 500-1000 tokens
raw_data ファイル平均:  800-1200 tokens
```

**シナリオ別計算**:

| シナリオ | ページ数 | Token/ページ | 合計 Token | 月額費用 |
|--------|--------|-----------|---------|--------|
| 初回同期 (Theory) | 42 | 750 | 31,500 | $0.00 (無料枠内) |
| 初回同期 (raw_data) | 50 | 1000 | 50,000 | $0.00 (無料枠内) |
| 初回合計 | 92 | - | 81,500 | ✅ $0.00 |
| 週 1 回同期 (差分 5ページ) | 5 | 850 | 4,250 | $0.00/月 |
| 月 4 回同期 (差分 20ページ) | 20 | 850 | 17,000 | $0.00/月 |
| **月 4 回 (超過時)** | 500 | - | **450,000** | **$33.75** |

**結論**: 月 100 ページ以下なら無料。500 ページ/月で $34。

---

### 2️⃣ dspy.Teleprompter - 最適化

**用途**: 100+ 試行で最適プロンプトを自動発見

#### 価格体系

```
Model: Gemini 2.0 Flash (高速, 安い)
- Input: $0.075 / 1M tokens
- Output: $0.30 / 1M tokens

Model: Gemini 2.0 Pro (高品質)
- Input: $1.50 / 1M tokens
- Output: $6.00 / 1M tokens

Model: Gemini 2.0 Thinking (推論重視)
- Input: $6.00 / 1M tokens
- Output: $24.00 / 1M tokens
```

#### コスト計算

**1 試行あたりの Token 数**:
```
SmashCoach.forward() = 
  - 入力: 質問 (100 tokens) + retriever 結果 (500 tokens) = 600 tokens
  - 出力: 【分析】(200 tokens) + 【アドバイス】(300 tokens) = 500 tokens

合計: 600 + 500 = 1,100 tokens/試行
```

#### シナリオ別計算

| 試行数 | Model | 入力 Token | 出力 Token | 入力費用 | 出力費用 | 合計 |
|-------|-------|----------|----------|--------|--------|------|
| 10 | Flash | 6,000 | 5,000 | $0.00 | $0.00 | ✅ $0.00 |
| 50 | Flash | 30,000 | 25,000 | $0.00 | $0.01 | ✅ $0.01 |
| 100 | Flash | 60,000 | 50,000 | $0.00 | $0.02 | ✅ $0.02 |
| **100** | **Pro** | 60,000 | 50,000 | $0.09 | $0.30 | **$0.39** |
| **100** | **Thinking** | 60,000 | 50,000 | $0.36 | $1.20 | **$1.56** |

**結論**:
- Flash で 100 試行: **$0.02** (安い!)
- Pro で 100 試行: **$0.39** (中程度)
- Thinking で 100 試行: **$1.56** (高い)

---

### 3️⃣ Pinecone - ベクトルストレージ

**用途**: 埋め込みベクトルを保存・検索

#### 価格体系

```
Standard Index:
- ストレージ: $0.10 / ベクトル / 月
- 操作: 無制限 (API call 数制限なし)

リクエスト単価: なし (固定料金)

例:
- 100 ベクトル: $10 / 月
- 1,000 ベクトル: $100 / 月
- 10,000 ベクトル: $1,000 / 月
```

#### シナリオ別計算

| ベクトル数 | ストレージ費用/月 | 説明 |
|----------|----------------|------|
| 100 (現在) | $10 | raw_data 50 + Notion Theory 42 + buffer |
| 150 (新ページ 50 追加) | $15 | 差分同期後 |
| 200 (新ページ 100 追加) | $20 | 大規模更新 |
| 1,000+ (スケール時) | $100+ | 将来検討 |

**結論**: 最初は $10/月。大規模スケール時に $100/月。

---

## 🔄 最適化サイクルのコスト見積もり

### パターン A: 月 1 回最適化 (現在の計画)

```
┌─────────────────────────────────────────────────┐
│ 1 回の最適化サイクル (月 1 回)                    │
└─────────────────────────────────────────────────┘

【Phase 1: データ収集】(実行者: ユーザー)
 フェーズ: 1-4 週間
 コスト: $0 (ユーザー操作のみ)
 概要: /teach で修正データを 30+ 個収集

【Phase 2: 差分同期】(実行者: 自動)
 実行: 最適化前に自動実行
 埋め込み処理:
  - 新規・更新ページ数: 5-10 個と想定
  - Token 数: 5-10 * 850 = 4,250-8,500 tokens
  - コスト: ✅ $0.00 (無料枠内)
 
 小計: $0.00

【Phase 3: 最適化実行】
 実行: python -m src.utils.optimize_coach
 
 Option A: Flash Model (推奨, 高速, 安い)
  - 試行回数: 100 試行
  - LLM コスト: $0.02
  小計: $0.02
 
 Option B: Pro Model (中程度品質)
  - 試行回数: 100 試行
  - LLM コスト: $0.39
  小計: $0.39
 
 Option C: Thinking Model (高品質)
  - 試行回数: 100 試行
  - LLM コスト: $1.56
  小計: $1.56

【Phase 4: Pinecone 更新】(オプション)
 新規ベクトル挿入: 0 (最適化はプロンプトのみ, ベクトル不変)
 コスト: ✅ $0.00
 
 小計: $0.00

【毎月固定費】
 Pinecone ストレージ: $10 (100 ベクトル)
 
 小計: $10.00

┌─────────────────────────────────────────────────┐
│ 【選択肢別】月 1 回最適化の合計コスト            │
├─────────────────────────────────────────────────┤
│ Flash  (推奨):    $0.02 + $10 = $10.02 / 月 ✅ │
│ Pro (中程度):     $0.39 + $10 = $10.39 / 月    │
│ Thinking (高品質): $1.56 + $10 = $11.56 / 月   │
└─────────────────────────────────────────────────┘
```

### パターン B: 月 4 回最適化 (高頻度)

```
 Flash:    (0.02 * 4) + $10 = $10.08 / 月 ✅
 Pro:      (0.39 * 4) + $10 = $11.56 / 月
 Thinking: (1.56 * 4) + $10 = $16.24 / 月
```

### パターン C: 週 1 回最適化 (積極的)

```
 Flash:    (0.02 * 4) + $10 = $10.08 / 月 ✅ (変わらず)
 Pro:      (0.39 * 4) + $10 = $11.56 / 月
 Thinking: (1.56 * 4) + $10 = $16.24 / 月

 ※ Flash は月 4 回で $0.08 なので価格ほぼ変わらず
```

---

## 📋 3 つの追加機能のコスト

### 機能 1: 最適化前に Notion 差分を自動検出 & 同期

**実装内容**:
```python
def check_notion_updates():
    # ハッシュ or タイムスタンプで差分検出
    # 新規・更新ページを特定
    # 該当ページのみ埋め込み + Pinecone 更新
```

**コスト分析**:

| 処理 | 実行頻度 | Token 数 | 月額コスト |
|------|--------|--------|--------|
| Notion API 呼び出し | 週 1 回 | - | ✅ $0.00 (無料) |
| 埋め込み (差分 3-5 ページ) | 週 1 回 | ~3,000 | ✅ $0.00 (無料枠内) |
| **小計** | - | - | **✅ $0.00** |

**月額追加コスト**: **$0.00** ✅ (Gemini 無料枠でカバー)

**判定**: ✅ **コスト効率的 → 実装推奨**

---

### 機能 2: 最適化後に Pinecone 更新をローカル DB に反映

**実装内容**:
```python
def sync_pinecone_to_local():
    # Pinecone から新規ベクトルを取得
    # ローカル SmashTheoryDB (SQLite or JSON) に保存
    # メタデータも同期
```

**コスト分析**:

| 処理 | 実行頻度 | 費用 | 説明 |
|------|--------|------|------|
| Pinecone クエリ | 月 1 回 | ✅ $0.00 | API 呼び出し無制限 |
| ローカル DB 更新 | 月 1 回 | ✅ $0.00 | ローカル処理 |
| **小計** | - | **✅ $0.00** | 無料 |

**月額追加コスト**: **$0.00** ✅

**判定**: ✅ **コスト無料 → 実装推奨**

---

### 機能 3: 最適化後に SmashTheoryDB 変更を自動で Notion に反映

⚠️ **警告**: この機能は **最も高コスト** です

**実装内容**:
```python
def sync_local_to_notion():
    # SmashTheoryDB の変更を検出
    # 新規 Theory ページを Notion に自動作成
    # 既存ページを更新
```

**コスト分析**:

| 処理 | 実行頻度 | Token 数 | コスト | 説明 |
|------|--------|--------|------|------|
| Notion API 呼び出し (Create) | 月 1 回 × 1-3 ページ | - | ✅ $0.00 | 無料 |
| Notion API 呼び出し (Update) | 月 1 回 × 5-10 ページ | - | ✅ $0.00 | 無料 |
| **Notion ページ埋め込み** | 月 1 回 × 1-3 新規 | ~2,000 | ✅ $0.00 | 無料枠内 |
| **小計** | - | - | **✅ $0.00** | 無料枠内 |

**月額追加コスト**: **$0.00** ✅ (初期段階)

**注意**: ページが急増すると無料枠を超える可能性

---

## 📈 スケールシナリオ別コスト

### シナリオ 1: 小規模 (初期段階) ← 現在ここ

```
ベクトル数: 100
最適化: 月 1 回, Flash モデル
Notion ページ: 42

月額コスト:
├─ Pinecone: $10 (100 ベクトル)
├─ 最適化: $0.02 (100 試行)
├─ 差分同期: $0.00
└─ 合計: $10.02 ✅
```

### シナリオ 2: 中規模 (成長期)

```
ベクトル数: 500 (新規ページ + 履歴)
最適化: 月 4 回, Pro モデル
Notion ページ: 100+

月額コスト:
├─ Pinecone: $50 (500 ベクトル)
├─ 最適化: $1.56 (4 × 100 試行, Pro)
├─ 差分同期: $0.50 (埋め込み超過)
└─ 合計: $52.06
```

### シナリオ 3: 大規模 (成熟期)

```
ベクトル数: 5,000+ (多言語対応 or 複数アプリ)
最適化: 週 1 回, Pro モデル
Notion ページ: 500+

月額コスト:
├─ Pinecone: $500 (5,000 ベクトル)
├─ 最適化: $15.60 (4 週 × Pro)
├─ 差分同期: $50 (埋め込み超過)
└─ 合計: $565.60
```

---

## 🎯 推奨実装プラン

### ✅ コスト効率的 (すぐ実装)

| 機能 | 月額コスト | 推奨度 | 理由 |
|------|----------|-------|------|
| **1. 差分検出 & Notion 同期** | $0.00 | ⭐⭐⭐ | 無料, 自動化効果大 |
| **2. Pinecone → ローカル反映** | $0.00 | ⭐⭐⭐ | 無料, 必須機能 |
| **3. ローカル → Notion 反映** | $0.00 | ⭐⭐ | 無料だが自動化度低い |

### ⚠️ コスト注意 (段階的実装)

| 機能 | 月額コスト | 条件 |
|------|----------|------|
| Pro モデル最適化 | +$1.56/月 | ベクトル数 < 500 なら OK |
| Thinking モデル | +$4.56/月 | 高品質が必須な場合のみ |
| 高頻度最適化 (週 1) | +$0.06/月 | Flash ならほぼ追加コストなし |

---

## 💡 コスト削減のコツ

### 1. Flash モデルを活用

```
100 試行の費用:
- Flash:  $0.02 (推奨) ← 速い + 安い
- Pro:    $0.39 (8 倍コスト)
- Thinking: $1.56 (30 倍コスト)
```

**結論**: Flash で十分。Pro / Thinking は不要。

### 2. 無料枠を最大活用

```
Gemini 埋め込み: 6 万 tokens/月 無料
→ 月 70 ページまで無料
```

### 3. 差分同期で無駄を削減

```
全同期: 92 ページ × 900 tokens = 82,800 tokens
差分同期: 5 ページ × 900 tokens = 4,500 tokens
削減率: 94.5% ↓
```

### 4. Pinecone ストレージ最適化

```
不要なベクトルを削除する仕組み
→ 月額費用削減
```

---

## 🚨 月額費用推移予測

```
Month 1:    $10.02  (初期セットアップ)
Month 2:    $10.02  (最適化 1 回)
Month 3:    $10.02  (最適化 1 回)
...
Month 12:   $10.02  (安定期)

年間費用: $120.24 ✅ (非常に安い)

※ Pro モデルに変更した場合:
Month 1-12: $10.39 / 月
年間費用: $124.68 (+$4.44)
```

---

## 📋 承認フォーム

| 項目 | 推奨 | 選択 | 理由 |
|------|------|------|------|
| **1. 差分検出 & Notion 同期** | ✅ | ☐ | $0.00, 自動化効果大 |
| **2. Pinecone → ローカル反映** | ✅ | ☐ | $0.00, 必須機能 |
| **3. ローカル → Notion 反映** | ⚠️ | ☐ | $0.00 だが優先度低い |
| **LLM モデル選択** | Flash | ☐ Flash ☐ Pro ☐ Thinking | Flash 推奨 ($0.02/100試行) |

---

## 🔗 参考

- [Gemini API 価格](https://ai.google.dev/pricing)
- [Pinecone 価格](https://www.pinecone.io/pricing/)
- [dspy.Teleprompter ドキュメント](https://dspy-docs.vercel.app/)

---

**このドキュメントを確認して、上記フォームに ✅ を入れて承認してください。**
